@page
@model PRN222_Group4_FinalProject_FPTUResearchPaperManagement.Pages.Student.MyTopicModel
@{
    ViewBag.ShowSidebar = true;
    ViewBag.ActiveMenu = "MyTopic";
    var filesByFolder = Model.Files?
    .GroupBy(f => f.File_Type)
    .ToDictionary(g => g.Key, g => g.ToList());
    bool isSubmitted = Model.Submission?.IsSubmitted == true;
    bool isSuspended = Model.Submission?.IsSuspended == true;
    int CountOf(string folder) =>
        filesByFolder.ContainsKey(folder) ? filesByFolder[folder].Count : 0;
}
@section Scripts {
    <script src="https://unpkg.com/@@microsoft/signalr@latest/dist/browser/signalr.js"></script>
    <script>
        "use strict";

        const groupId = @(Model.Submission?.GroupId ?? 0);

        function showSignalrBanner(message, reloadAfterMs = 1800) {
            let banner = document.getElementById("signalrBanner");
            if (!banner) {
                banner = document.createElement("div");
                banner.id = "signalrBanner";
                banner.className = "alert alert-info fixed-top text-center mt-3 mx-auto w-50";
                banner.style.zIndex = 1050;
                document.body.appendChild(banner);
            }
            banner.textContent = message;
            banner.style.display = "block";

            document.querySelectorAll(".folder-link").forEach(el => {
                el.classList.add("disabled-folder");
                el.setAttribute("aria-disabled", "true");
            });
            const submitBtn = document.querySelector(".submission-footer button[data-bs-target='#confirmSubmitModal']");
            if (submitBtn) submitBtn.disabled = true;

            if (reloadAfterMs) setTimeout(() => window.location.reload(), reloadAfterMs);
        }

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/notificationHub")
            .withAutomaticReconnect([0, 2000, 5000, 10000])
            .build();

        function setApprovalBadge(id, status, reviewerName) {
            const el = document.getElementById(id);
            if (!el) return;
            let cls = "badge bg-secondary";
            let text = "—";
            if (!status) {
                el.innerHTML = '<span class="text-muted">—</span>';
                return;
            }
            const s = status.toString();
            if (s === "Approve" || s === "Approved") { cls = "badge bg-success"; text = "Đã phê duyệt"; }
            else if (s === "Reject" || s === "Rejected") { cls = "badge bg-danger"; text = "Bị từ chối"; }
            else if (s === "Suspend" || s === "Suspended") { cls = "badge bg-warning text-dark"; text = "Đình chỉ"; }
            else if (s === "Reviewing") { cls = "badge bg-info"; text = "Đang xem xét"; }
            else if (s === "Submitted") { cls = "badge bg-primary"; text = "Đã nộp"; }

            el.innerHTML = `<span class="${cls}">${text}</span>` +
                (reviewerName ? `<div class="small text-muted">${reviewerName}</div>` : "");
        }

        connection.on("ReceiveApprovalUpdate", function (data) {
            try {
                if (!data) return;
                if (data.groupId == null || Number(data.groupId) !== Number(groupId)) return;

                // Try to update badges locally if server sent role votes (optional)
                if (data.instructorVote || data.gpecVote) {
                    setApprovalBadge("instructorApproval", data.instructorVote?.status, data.instructorVote?.name);
                    setApprovalBadge("gpecApproval", data.gpecVote?.status, data.gpecVote?.name);
                }

                // If server sends final submission status, show banner and reload for accurate state
                const status = (data.newStatus || data.submissionStatus || "").toString();
                const finalStatuses = ["Approved", "Rejected", "Suspended"];
                if (finalStatuses.includes(status)) {
                    showSignalrBanner("Submission status updated: " + status);
                } else {
                    // partial update: refresh badges by reloading small area (reload page here)
                    showSignalrBanner("Submission status changed: " + status, 1200);
                }
            } catch (e) {
                console.error("ReceiveApprovalUpdate handler error:", e);
            }
        });

        connection.on("SubmissionSubmitted", function (data) {
            try {
                if (!data) return;
                if (Number(data.groupId) !== Number(groupId)) return;
                showSignalrBanner("Your group has submitted. Status: " + (data.submissionStatus || "Submitted"));
            } catch (e) {
                console.error("SubmissionSubmitted handler error:", e);
            }
        });

        async function startSignalR() {
            try {
                await connection.start();
                console.debug("SignalR connected (MyTopic)");
            } catch (err) {
                console.warn("SignalR start failed, retrying...", err);
                setTimeout(startSignalR, 2000);
            }
        }
        startSignalR();

        connection.onreconnecting(error => console.warn("SignalR reconnecting", error));
        connection.onreconnected(connectionId => console.debug("SignalR reconnected", connectionId));
    </script>
}

<head>
    <title>@ViewData["Title"] - PRN222_Group4_FinalProject_FPTUResearchPaperManagement</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>

<div class="rounded p-3 d-flex flex-row gap-3 bg-white shadow-sm">
    <div class="topic-inner w-100">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <h3 class="mb-0">Đề Tài Đã Đăng Ký</h3>

            @if (isSuspended)
            {
                <div class="alert alert-danger py-1 px-3 mb-0">
                    ⚠ Bạn đã bị đình chỉ do vi phạm học thuật. Mọi thao tác nộp bài đã bị khóa.
                </div>
            }
            else if (isSubmitted)
            {
                <div class="alert alert-success py-1 px-3 mb-0">
                    ✔ Nộp bài thành công. Đề tài đang được chờ duyệt.
                </div>
            }
        </div>

        @if (Model.RegisteredTopic == null || Model.RegisteredTopic.Status != "Assigned")
        {
            <div class="text-center my-5">
                <img src="~/assets/empty_box.png" style="width:150px; opacity:0.8;" />
                <p class="mt-3 text-muted">Bạn chưa đăng ký đề tài nào hoặc đề tài chưa được phê duyệt.</p>
            </div>
        }
        else
        {
            <div class="container-fluid rounded p-3 d-flex flex-row gap-3">
                <!-- Left: Topic details + members -->
                <div class="flex-fill border-end pe-3">
                    <h4>@Model.RegisteredTopic.Title</h4>
                    <p>
                        <strong>Chuyên ngành:</strong> @Model.RegisteredTopic.Major <br />
                        <strong>Học kỳ:</strong> @Model.RegisteredTopic.SemesterTerm <br />
                    </p>

                    @if (Model.RegisteredTopic.Members.Any())
                    {
                        <p><strong>Thành viên:</strong></p>
                        <ul>
                            @foreach (var m in Model.RegisteredTopic.Members)
                            {
                                <li>
                                    @m.Full_Name
                                    @if (m.IsLeader)
                                    {
                                        <span class="badge bg-warning text-dark ms-1">⭐ Nhóm trưởng</span>
                                    }
                                </li>
                            }
                        </ul>
                    }
                </div>

                <!-- Right: Submission Instructions + Countdown -->
                <div class="flex-fill ps-3 d-flex flex-column justify-content-between">
                    <div>
                        <h5>Hướng dẫn nộp bài</h5>
                        <p style="white-space: pre-wrap;">
                            <strong>@Html.Raw(Model.RegisteredTopic.SubmissionInstruction?.TrimStart())</strong>
                        </p>
                    </div>
                    <div class="mt-3 text-center">
                        <h6>Hạn nộp còn lại:</h6>
                        <div id="countdown" class="fs-5 fw-bold"></div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@if (Model.RegisteredTopic != null && Model.RegisteredTopic.Status == "Assigned")
{
    <div class="container-fluid mt-4 px-0">
        <div class="bg-white shadow-sm rounded submission-card">
            <!-- Header -->
            <div class="row text-center submission-header fw-semibold">
                <div class="col border-end">Phê duyệt của GVHD</div>
                <div class="col border-end">Xác nhận của Thành viên Hội Đồng</div>
                <div class="col">Thư mục</div>
            </div>

            <!-- Content -->
            <div class="row submission-body text-center">
                <div class="col border-end">
                    <div id="instructorApproval" class="d-flex flex-column align-items-center">
                    @switch (Model.InstructorStatus)
                    {
                        case ReviewStatus.Approved:
                            <span class="badge bg-success">Đã phê duyệt</span>
                            break;
                        case ReviewStatus.Rejected:
                            <span class="badge bg-danger">Bị từ chối</span>
                            break;
                        case ReviewStatus.Suspended:
                            <span class="badge bg-warning">Đình chỉ</span>
                            break;
                        default:
                            <span class="text-muted fw-semibold">Đang chờ</span>
                            break;
                    }
                    <br/>
                        <strong>Ghi chú:</strong> @Model.InstructorComment
                    </div>
                </div>
                <div class="col border-end">
                    <div id="gpecApproval" class="d-flex flex-column align-items-center">
                        @switch (Model.GpecStatus)
                        {
                            case ReviewStatus.Approved:
                                <span class="badge bg-success">Đã xác nhận</span>
                                break;
                            case ReviewStatus.Rejected:
                                <span class="badge bg-danger">Bị từ chối</span>
                                break;
                            case ReviewStatus.Suspended:
                                <span class="badge bg-warning">Đình chỉ</span>
                                break;
                            default:
                                <span class="text-muted fw-semibold">Đang chờ</span>
                                break;
                        }
                    <br/>
                        <strong>Ghi chú:</strong> @Model.GpecComment
                    </div>
                </div>
                <div class="col text-start">
                    <ul class="list-unstyled mb-0 directory-list">

                        <!-- Final Thesis and Reports -->
                        <li class="d-flex align-items-center justify-content-between">
                            @if (isSubmitted || isSuspended || Model.SubmissionStatus == ReviewStatus.Approved)
                            {
                                <a class="folder-link disabled-folder" aria-disabled="true">
                                    <span>
                                        <i class="bi bi-folder-fill text-primary me-2"></i>
                                        Final Thesis and Reports
                                    </span>
                                </a>
                            }
                            else
                            {
                                <a asp-page="./MyTopic"
                                   asp-route-folder="Final Thesis and Reports"
                                   class="folder-link">
                                    <span>
                                        <i class="bi bi-folder-fill text-primary me-2"></i>
                                        Final Thesis and Reports
                                    </span>
                                </a>
                            }

                            @if (CountOf("Final Thesis and Reports") > 0)
                            {
                                <small class="text-success ms-2">
                                    ✔ @CountOf("Final Thesis and Reports") file(s)
                                </small>
                            }
                        </li>

                        <!-- Slides -->
                        <li class="d-flex align-items-center justify-content-between">
                            @if (isSubmitted || isSuspended)
                            {
                                <a class="folder-link disabled-folder" aria-disabled="true">
                                    <span>
                                        <i class="bi bi-folder-fill text-primary me-2"></i>
                                        Slides
                                    </span>
                                </a>
                            }
                            else
                            {
                                <a asp-page="./MyTopic"
                                   asp-route-folder="Slides"
                                   class="folder-link">
                                    <span>
                                        <i class="bi bi-folder-fill text-primary me-2"></i>
                                        Slides
                                    </span>
                                </a>
                            }

                            @if (CountOf("Slides") > 0)
                            {
                                <small class="text-success ms-2">
                                    ✔ @CountOf("Slides") file(s)
                                </small>
                            }
                        </li>

                        <!-- Others -->
                        <li class="d-flex align-items-center justify-content-between">
                            @if (isSubmitted || isSuspended || Model.SubmissionStatus == ReviewStatus.Approved)
                            {
                                <a class="folder-link disabled-folder" aria-disabled="true">
                                    <span>
                                        <i class="bi bi-folder-fill text-primary me-2"></i>
                                        Others
                                    </span>
                                </a>
                            }
                            else
                            {
                                <a asp-page="./MyTopic"
                                   asp-route-folder="Others"
                                   class="folder-link">
                                    <span>
                                        <i class="bi bi-folder-fill text-primary me-2"></i>
                                        Others
                                    </span>
                                </a>
                            }

                            @if (CountOf("Others") > 0)
                            {
                                <small class="text-success ms-2">
                                    ✔ @CountOf("Others") file(s)
                                </small>
                            }
                        </li>

                    </ul>
                </div>
            </div>

            <!-- Footer -->
            <div class="submission-footer text-end p-2">
                @if (isSuspended)
                {
                    <button class="btn btn-danger px-4" disabled>
                        ⛔ Tài khoản bị đình chỉ
                    </button>
                }
                else if (Model.SubmissionStatus == ReviewStatus.Approved)
                {
                    <span class="btn btn-success px-4">✔ Đề tài đã được duyệt</span>
                }
                else if (isSubmitted)
                {
                    <button class="btn btn-success px-4" disabled>
                        ✔ Đã nộp bài
                    </button>
                }
                else
                {
                    <button class="btn btn-primary px-4"
                            data-bs-toggle="modal"
                            data-bs-target="#confirmSubmitModal">
                        Xác nhận nộp bài
                    </button>
                }
            </div>
        </div>
    </div>
}

<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title">
                        Nộp bài vào thư mục: <span id="folderName"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" name="FolderName" id="folderInput" />
                    <div class="mb-3">
                        <label class="form-label">Chọn file</label>
                        <input type="file" name="UploadFile" class="form-control" id="uploadFileInput" required />
                        <div id="fileSizeError" class="text-danger mt-1" style="display:none;">
                            File không được vượt quá 2GB!
                        </div>
                    </div>
                <div >
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Hủy
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Tải lên
                    </button>
                </div>
                </div>

            </form>

                @if (Model.Files.Any(f => f.File_Type == Model.CurrentFolder))
                {
                    <ul class="list-group mt-3">
                        @foreach (var f in Model.Files.Where(f => f.File_Type == Model.CurrentFolder))
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <a href="@f.Firebase_Url" target="_blank"  class="text-truncate d-inline-block"
                                   style="max-width: 260px;">
                                    @f.File_Name
                                </a>
                                <div class="d-flex align-items-center">
                                    <span class="text-muted small me-2">
                                        @f.Uploaded_At.ToString("dd/MM/yyyy HH:mm")
                                    </span>
                                    <!-- Red X icon -->
                                    <form method="post"
                                          asp-page-handler="DeleteFile"
                                          asp-route-id="@f.Id"
                                          asp-route-folderName="@Model.FolderName">

                                        <button type="submit" class="btn btn-link text-danger p-0">
                                            <i class="bi bi-x-circle fs-5"></i>
                                        </button>
                                    </form>


                                </div>
                            </li>
                        }
                    </ul>
                }

        </div>
    </div>
</div>

<div class="modal fade" id="confirmSubmitModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post" asp-page-handler="SubmitFinal">
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận nộp bài</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <p>
                        Sau khi nộp bài, bạn <strong>không thể chỉnh sửa hoặc tải thêm file</strong>.
                    </p>
                    <p>Bạn có chắc chắn muốn nộp bài không?</p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Hủy
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Xác nhận nộp
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


@if (!string.IsNullOrEmpty(Model.CurrentFolder))
{
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // set folder name
            document.getElementById("folderName").innerText = "@Model.CurrentFolder";
            document.getElementById("folderInput").value = "@Model.CurrentFolder";

            // open modal
            const modal = new bootstrap.Modal(
                document.getElementById("uploadModal")
            );
            modal.show();
        });
    </script>
}



<script>
    const deadline = new Date("@Model.RegisteredTopic?.Deadline_Date.ToString("yyyy-MM-ddTHH:mm:ss")").getTime();

    const countdownEl = document.getElementById("countdown");

    if(deadline){
        const timer = setInterval(function() {
            const now = new Date().getTime();
            const distance = deadline - now;

            if (distance < 0) {
                clearInterval(timer);
                countdownEl.innerHTML = "Hết hạn!";
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            countdownEl.innerHTML =
                (days > 0 ? days + " ngày " : "") +
                String(hours).padStart(2,'0') + " : " +
                String(minutes).padStart(2,'0') + " : " +
                String(seconds).padStart(2,'0');
        }, 1000);
    }
     function openUploadModal(el) {
        const folder = el.getAttribute("data-folder");

        document.getElementById("folderName").innerText = folder;
        document.getElementById("folderInput").value = folder;

        const modal = new bootstrap.Modal(
            document.getElementById("uploadModal")
        );
        modal.show();
    }
    const fileInput = document.getElementById("uploadFileInput");
    const fileSizeError = document.getElementById("fileSizeError");

    fileInput.addEventListener("change", function() {
        const file = fileInput.files[0];
        const maxSize = 2 * 1024 * 1024 * 1024; 

        if (file && file.size > maxSize) {
            fileSizeError.style.display = "block";
            fileInput.value = "";
        } else {
            fileSizeError.style.display = "none";
        }
    });

        document.querySelectorAll('.delete-file-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const fileId = this.getAttribute('data-file-id');
            if(confirm("Bạn có chắc chắn muốn xóa file này?")) {
                // Call your API to delete file using fileId
                console.log("Delete file with ID:", fileId);
            }
        });
    });
</script>
