@page "{submissionId:int}"
@model PRN222_Group4_FinalProject_FPTUResearchPaperManagement.Pages.GPEC.Submission.DetailsModel
@{
    ViewData["Title"] = "Submission Details";
    ViewData["ShowSidebar"] = true;
    ViewData["ActiveMenu"] = "TopicSubmissions";
}

<div class="container mt-3">

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="card border-danger shadow-sm mb-3">
            <div class="card-header bg-danger text-white fw-bold">
                ❌ Error
            </div>
            <div class="card-body">
                <p class="mb-0 text-danger">
                    @TempData["ErrorMessage"]
                </p>
            </div>
        </div>
    }

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold">Submission Details</h4>
        <a asp-page="./Index" class="btn btn-secondary">
            ← Back
        </a>
    </div>

    @if (Model.Submission == null)
    {
        <div class="alert alert-warning">
            Submission not found.
        </div>
    }
    else
    {
        <!-- Submission summary -->
        <div class="card shadow-sm mb-3">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1">Submission #@Model.SubmissionId</h5>
                    <div class="small text-muted">
                        Submitted at:
                        @(Model.Submission.SubmittedAt?.ToString("dd/MM/yyyy HH:mm") ?? "—")
                    </div>
                </div>

                <span class="badge fs-6 px-3
                    @(Model.Submission.Status == "Approved" ? "bg-success" :
                      Model.Submission.Status == "Rejected" ? "bg-danger" :
                      Model.Submission.Status == "Suspended" ? "bg-warning text-dark" :
                      Model.Submission.Status == "Reviewing" ? "bg-info text-dark" :
                      "bg-secondary")">
                    @Model.Submission.Status
                </span>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.Submission.RejectReason) && Model.Submission.Status == nameof(SubmissionStatus.Rejected))
        {
            <div class="alert alert-danger shadow-sm">
                <h6 class="alert-heading mb-1">❌ Rejection Reason</h6>
                <p class="mb-0">@Model.Submission.RejectReason</p>
            </div>
        }

        <!-- Plagiarism warning -->
        @if (Model.Submission.PlagiarismFlag)
        {
            <div class="alert alert-warning border-warning shadow-sm">
                <h6 class="alert-heading mb-1">⚠️ Possible plagiarism detected</h6>
                <p class="mb-1">
                    Plagiarism score:
                    <strong>@Model.Submission.PlagiarismScore</strong>
                </p>
                <small class="text-muted">
                    This result is generated automatically and may be inaccurate.
                </small>
            </div>
        }

        <!-- Votes summary -->
        <h5 class="mt-4 mb-2">Current Votes</h5>
        <div class="row mb-3">
            @foreach (var role in new[] { "Instructor", "GraduationProjectEvaluationCommitteeMember" })
            {
                Model.LatestVotes.TryGetValue(role, out var vote);

                <div class="col-md-6">
                    <div class="card shadow-sm mb-2">
                        <div class="card-body">
                            <h6 class="card-title">@role</h6>

                            @if (vote == null)
                            {
                                <span class="text-muted">No vote yet</span>
                            }
                            else
                            {
                                <span class="badge
                                    @(vote.New_Status == "Approve" ? "bg-success" :
                                      vote.New_Status == "Reject" ? "bg-danger" :
                                      vote.New_Status == "Suspend" ? "bg-warning text-dark" :
                                      "bg-secondary")">
                                    @vote.New_Status
                                </span>

                                <div class="small text-muted mt-1">
                                    by @(vote.Reviewer?.Full_Name ?? vote.Reviewer?.Email ?? "Unknown")<br />
                                    @vote.Created_At.ToString("dd/MM/yyyy HH:mm")<br />
                                    @vote.Comment
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Members -->
        <div class="card shadow-sm mb-3">
            <div class="card-header fw-bold">Members</div>
            <ul class="list-group list-group-flush">
                @foreach (var m in Model.Members)
                {
                    <li class="list-group-item">
                        @m.FullName (@m.Email)
                        @if (m.IsLeader)
                        {
                            <span class="badge bg-warning text-dark ms-1">⭐ Leader</span>
                        }
                    </li>
                }
            </ul>
        </div>

        <!-- Files -->
        <div class="card shadow-sm mb-3">
            <div class="card-header fw-bold">Files</div>

            @if (!Model.Files.Any())
            {
                <div class="card-body text-muted">
                    No files uploaded for this submission.
                </div>
            }
            else
            {
                <ul class="list-group list-group-flush">
                    @foreach (var f in Model.Files)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>@f.File_Name</strong>
                                <div class="small text-muted">
                                    @f.File_Type • @f.Uploaded_At.ToString("dd/MM/yyyy HH:mm")
                                </div>
                            </div>
                            <a asp-page="/Instructor/Submission/DownloadFile"
                               asp-route-fileId="@f.Id"
                               class="btn btn-sm btn-outline-primary">
                                View / Download
                            </a>
                        </li>
                    }
                </ul>
            }
        </div>

        <!-- Review history -->
        <div class="card shadow-sm mb-3">
            <div class="card-header fw-bold">Review History</div>

            @if (!Model.ReviewLogs.Any())
            {
                <div class="card-body text-muted">No reviews yet.</div>
            }
            else
            {
                <ul class="list-group list-group-flush">
                    @foreach (var log in Model.ReviewLogs.OrderByDescending(l => l.Created_At))
                    {
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>@(log.Reviewer?.Full_Name ?? log.Reviewer?.Email ?? "Unknown")</strong>
                                    <div class="small text-muted">
                                        @log.Created_At.ToString("dd/MM/yyyy HH:mm")
                                    </div>
                                </div>

                                <span class="badge
                                    @(log.New_Status == "Approve" ? "bg-success" :
                                      log.New_Status == "Reject" ? "bg-danger" :
                                      log.New_Status == "Suspend" ? "bg-warning text-dark" :
                                      "bg-secondary")">
                                    @log.New_Status
                                </span>
                            </div>

                            @if (!string.IsNullOrWhiteSpace(log.Comment))
                            {
                                <div class="mt-2">
                                    @log.Comment
                                </div>
                            }
                        </li>
                    }
                </ul>
            }
        </div>

        <!-- Review action -->
        <div class="card shadow-sm border-primary mb-4">
            <div class="card-header fw-bold">Your Review</div>
            <div class="card-body">
                <form method="post" asp-page-handler="Review">
                    <div class="mb-3">
                        <label class="form-label">Comment (optional)</label>
                        <textarea name="comment" class="form-control" rows="3"></textarea>
                    </div>

                    @if (string.Equals(Model.Submission.Status, "Approved", StringComparison.OrdinalIgnoreCase))
                    {
                        <div class="alert alert-info small">
                            This submission has been approved. You may still submit a rejection.
                        </div>
                        <button type="submit" name="decision" value="Reject" class="btn btn-danger">
                            Reject
                        </button>
                    }
                    else
                    {
                        @if (Model.HasCurrentUserApproved)
                        {
                            <button class="btn btn-success" disabled>
                                ✔ Approved (already voted)
                            </button>
                        }
                        else
                        {
                            <button type="submit" name="decision" value="Approve" class="btn btn-success me-2">
                                Approve
                            </button>
                        }

                        <button type="submit" name="decision" value="Reject" class="btn btn-danger me-2">
                            Reject
                        </button>

                        @if (Model.Submission.PlagiarismFlag)
                        {
                            <button type="submit" name="decision" value="Suspend" class="btn btn-warning">
                                Suspend
                            </button>
                        }
                    }
                </form>
            </div>
        </div>
    }
</div>

