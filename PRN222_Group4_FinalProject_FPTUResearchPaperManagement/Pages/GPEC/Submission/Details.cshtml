@page "{submissionId:int}"
@model PRN222_Group4_FinalProject_FPTUResearchPaperManagement.Pages.GPEC.Submission.DetailsModel
@{
    ViewData["Title"] = "GPEC - Review";
    ViewData["ShowSidebar"] = true;
    ViewData["ActiveMenu"] = "TopicSubmissions";
}

<div class="container bg-white rounded shadow-sm p-4 mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Review Submission — ID: @Model.SubmissionId</h4>
        <a asp-page="./Index" class="btn btn-secondary">Back</a>
    </div>

    <div class="mb-3">
        <p><strong>Status:</strong> @Model.Submission.Status</p>
        <p><strong>Plagiarism flag:</strong> @(Model.Submission.PlagiarismFlag ? "Yes" : "No")</p>
        <p><strong>Plagiarism score:</strong> @Model.Submission.PlagiarismScore</p>
        @if (!string.IsNullOrEmpty(Model.Submission.RejectReason))
        {
            <p><strong>Reject reason:</strong> @Model.Submission.RejectReason</p>
        }
    </div>

    <!-- Latest votes summary -->
    <div class="mb-3">
        <h5>Current Votes</h5>
        <div class="d-flex gap-4">
            <div>
                <strong>Instructor:</strong>
                @{
                    Model.LatestVotes.TryGetValue("Instructor", out var instrVote);
                    if (instrVote != null)
                    {
                        var instrName = !string.IsNullOrWhiteSpace(instrVote.Reviewer?.Full_Name)
                        ? instrVote.Reviewer.Full_Name
                        : instrVote.Reviewer?.Email ?? "Unknown";
                        <span class="badge @(instrVote.New_Status == "Approve" ? "bg-success" : instrVote.New_Status == "Reject" ? "bg-danger" : instrVote.New_Status == "Suspend" ? "bg-warning text-dark" : "bg-secondary")">
                            @instrVote.New_Status
                        </span>
                        <div class="small text-muted">by @instrName on @instrVote.Created_At.ToString("dd/MM/yyyy HH:mm")</div>
                    }
                    else
                    {
                        <span class="text-muted">—</span>
                    }
                }
            </div>

            <div>
                <strong>GPEC:</strong>
                @{
                    Model.LatestVotes.TryGetValue("GraduationProjectEvaluationCommitteeMember", out var gpecVote);
                    if (gpecVote != null)
                    {
                        var gpecName = !string.IsNullOrWhiteSpace(gpecVote.Reviewer?.Full_Name)
                        ? gpecVote.Reviewer.Full_Name
                        : gpecVote.Reviewer?.Email ?? "Unknown";
                        <span class="badge @(gpecVote.New_Status == "Approve" ? "bg-success" : gpecVote.New_Status == "Reject" ? "bg-danger" : gpecVote.New_Status == "Suspend" ? "bg-warning text-dark" : "bg-secondary")">
                            @gpecVote.New_Status
                        </span>
                        <div class="small text-muted">by @gpecName on @gpecVote.Created_At.ToString("dd/MM/yyyy HH:mm")</div>
                    }
                    else
                    {
                        <span class="text-muted">—</span>
                    }
                }
            </div>
        </div>
    </div>

    <h5>Members</h5>
    <ul>
        @foreach (var m in Model.Members)
        {
            <li>@m.FullName (@m.Email) @if(m.IsLeader){
            <span class="badge bg-warning text-dark">⭐ Leader</span>
        }
</li>
                }
    </ul>

    <h5>Files</h5>
    @if (!Model.Files.Any())
    {
        <div class="alert alert-info">No files uploaded.</div>
    }
    else
    {
        <ul class="list-group mb-3">
            @foreach (var f in Model.Files)
            {
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>@f.File_Name</strong><br />
                        <small class="text-muted">@f.File_Type • @f.Uploaded_At.ToString("dd/MM/yyyy HH:mm")</small>
                    </div>
                    <div>
                        <a asp-page="/Instructor/Submission/DownloadFile" asp-route-fileId="@f.Id" class="btn btn-sm btn-outline-primary">Download</a>
                    </div>
                </li>
            }
        </ul>
    }

    <h5>Review History</h5>
    @if (!Model.ReviewLogs.Any())
    {
        <div class="alert alert-secondary">No reviews yet.</div>
    }
    else
    {
        <ul class="list-group mb-3">
            @foreach (var log in Model.ReviewLogs.OrderByDescending(l => l.Created_At))
            {
                var reviewerName = !string.IsNullOrWhiteSpace(log.Reviewer?.Full_Name)
                ? log.Reviewer.Full_Name
                : log.Reviewer?.Email ?? "Unknown";
                <li class="list-group-item">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>@reviewerName</strong>
                            @* Removed the fallback "Unknown role" so role will be shown only when present *@
                            @if (!string.IsNullOrWhiteSpace(log.Reviewer?.Role))
                            {
                                <span class="text-muted small">(@log.Reviewer.Role)</span>
                            }
                            <div class="small text-muted">@log.Created_At.ToString("dd/MM/yyyy HH:mm")</div>
                        </div>
                        <div class="text-end">
                            <span class="badge @(log.New_Status == "Approve" ? "bg-success" : log.New_Status == "Reject" ? "bg-danger" : log.New_Status == "Suspend" ? "bg-warning text-dark" : "bg-secondary")">
                                @log.New_Status
                            </span>
                        </div>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(log.Comment))
                    {
                        <div class="mt-2">@log.Comment</div>
                    }
                </li>
            }
        </ul>
    }

    <form method="post" asp-page-handler="Review" class="mt-3">
        <div class="mb-3">
            <label class="form-label">Comment (optional)</label>
            <textarea name="comment" class="form-control"></textarea>
        </div>

        @* If submission already Approved: allow only Reject (GPEC requirement) *@
        @if (string.Equals(Model.Submission.Status, "Approved", StringComparison.OrdinalIgnoreCase))
        {
            <div class="mb-2">
                <div class="alert alert-info small mb-1">This submission has been approved. You can still submit a rejection if needed.</div>
            </div>
            <button type="submit" name="decision" value="Reject" class="btn btn-warning">Reject</button>
        }
        else
        {
            @if (Model.Submission.PlagiarismFlag)
            {
                <button type="submit" name="decision" value="Suspend" class="btn btn-danger">Vote Suspend</button>
                <button type="submit" name="decision" value="Reject" class="btn btn-warning">Reject</button>
            }
            else
            {
                if (Model.HasCurrentUserApproved)
                {
                    <button type="button" class="btn btn-success" disabled title="You already approved this submission">Approve (already voted)</button>
                }
                else
                {
                    <button type="submit" name="decision" value="Approve" class="btn btn-success">Approve</button>
                }
                <button type="submit" name="decision" value="Reject" class="btn btn-warning ms-2">Reject</button>
            }
        }
    </form>
</div>